\section{Tsearch2}

Как и многие современные СУБД, PostgreSQL имеет встроенный механизм полнотекстового поиска. Отметим, что операторы поиска по текстовым данных существовали очень давно, это операторы \lstinline!LIKE!, \lstinline!ILIKE!, \lstinline!~!, \lstinline!~*!. Однако, они не годились для эффективного полнотекстового поиска, так как:

\begin{itemize}
  \item У них не было лингвистической поддержки, например, при поиске слова \lstinline!satisfies! будут не найдены документы со словом \lstinline!satisfy! и никакими регулярными выражениями этому не помочь. В принципе, используя \lstinline!OR! и все формы слова, можно найти все необходимые документы, но это очень неэффективно, так как в некоторых языках могут быть слова со многими тысячами форм!;
  \item Они не предоставляют никакой информации для ранжирования (сортировки) документов, что делает такой поиск практически бесполезным, если только не существует другой сортировки или в случае малого количества найденных документов;
  \item Они, в целом, очень медленные из-за того, что они каждый раз просматривают весь документ и не имеют индексной поддержки;
\end{itemize}

Для улучшения ситуации Олег Бартунов и Федор Сигаев предложили и реализовали новый полнотекстовый поиск, существовавший как модуль расширения и интегрированный в PostgreSQL, начиная с версии 8.3~--- \href{https://www.postgresql.org/docs/current/static/tsearch2.html}{Tsearch2}.

Идея нового поиска состояла в том, чтобы затратить время на обработку документа один раз и сохранить время при поиске, использовать специальные программы-словари для нормализации слов, чтобы не заботиться, например, о формах слов, учитывать информацию о важности различных атрибутов документа и положения слова из запроса в документе для ранжирования найденных документов. Для этого, требовалось создать новые типы данных, соответствующие документу и запросу, и полнотекстовый оператор для сравнения документа и запроса, который возвращает \lstinline!TRUE!, если запрос удовлетворяет запросу, и в противном случае - \lstinline!FALSE!.

PostgreSQL предоставляет возможность как для создания новых типов данных, операторов, так и создания индексной поддержки для доступа к ним, причем с поддержкой конкурентности и восстановления после сбоев. Однако, надо понимать, что индексы нужны только для ускорения поиска, сам поиск обязан работать и без них. Таким образом, были созданы новые типы данных - \lstinline!tsvector!, который является хранилищем для лексем из документа, оптимизированного для поиска, и \lstinline!tsquery! - для запроса с поддержкой логических операций, полнотекстовый оператор <<две собаки>> \lstinline!@@! и индексная поддержка для него с использованием GiST и GIN. \lstinline!tsvector! помимо самих лексем может хранить информацию о положении лексемы в документе и ее весе (важности), которая потом может использоваться для вычисления ранжирующей информации.

\subsection{Установка и использование}

Для начала активируем расширение:

\begin{lstlisting}[language=SQL,label=lst:tsearch1,caption=Активация tsearch2]
# CREATE EXTENSION tsearch2;
\end{lstlisting}

Проверим его работу:

\begin{lstlisting}[language=SQL,label=lst:tsearch2,caption=Проверка tsearch2]
# SELECT 'This is test string'::tsvector;
          tsvector
-----------------------------
 'This' 'is' 'string' 'test'
(1 row)

# SELECT strip(to_tsvector('The air smells of sea water.'));
            strip
-----------------------------
 'air' 'sea' 'smell' 'water'
(1 row)
\end{lstlisting}


\subsection{Заключение}

Данное расширение заслуживает отдельной книги, поэтому лучше ознакомиться с ним подробнее в <<\href{http://www.sai.msu.su/~megera/postgres/talks/fts\_pgsql\_intro.html}{Введение в полнотекстовый поиск в PostgreSQL}>> документе.
